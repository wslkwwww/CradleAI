## Replicate æ–‡æœ¬åˆ°å›¾åƒåç«¯æœåŠ¡

ä¸€ä¸ªä½¿ç”¨ Replicate API ç”Ÿæˆå›¾åƒå¹¶å°†å›¾åƒå­˜å‚¨åœ¨ MinIO å¯¹è±¡å­˜å‚¨ä¸­çš„ Node.js åç«¯æœåŠ¡ã€‚ç°åœ¨æ”¯æŒå®æ—¶çŠ¶æ€æ›´æ–°å’Œå¯é çš„ä»»åŠ¡é‡è¯•æœºåˆ¶ã€‚

## ç‰¹ç‚¹

- ä½¿ç”¨ Replicate çš„æ–‡æœ¬åˆ°å›¾åƒæ¨¡å‹ (Animagine-XL-4.0) ç”Ÿæˆå›¾åƒ
- å°†ç”Ÿæˆçš„å›¾åƒå­˜å‚¨åœ¨ MinIO å¯¹è±¡å­˜å‚¨ä¸­
- ç”¨äºå›¾åƒç”Ÿæˆçš„ RESTful API ç«¯ç‚¹
- å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
- åŸºäºç¯å¢ƒçš„é…ç½®
- **å®æ—¶ä»»åŠ¡çŠ¶æ€æ›´æ–° (SSE)**
- **å¯é çš„æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å’Œä»»åŠ¡é‡è¯•æœºåˆ¶ (RabbitMQ)**
- **æ”¯æŒå¤§é‡å¹¶å‘è¯·æ±‚å¤„ç†**

## è®¾ç½®

### å‰ææ¡ä»¶

- Node.js v14+
- MinIO æœåŠ¡å™¨
- Replicate API ä»¤ç‰Œ
- RabbitMQ æœåŠ¡å™¨

### å®‰è£…

1. å…‹éš†ä»“åº“
2. å®‰è£…ä¾èµ–é¡¹ï¼š

```bash
npm install
```

3. åŸºäº `.env.example` æ–‡ä»¶åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cp .env.example .env
```

4. ä½¿ç”¨æ‚¨çš„å‡­æ®å’Œé…ç½®ç¼–è¾‘ `.env` æ–‡ä»¶ã€‚

### è¿è¡ŒæœåŠ¡

å¯åŠ¨æœåŠ¡å™¨ï¼š

```bash
npm start
```

ç”¨äºå¸¦æœ‰è‡ªåŠ¨é‡è½½çš„å¼€å‘ï¼š

```bash
npm run dev
```

é›†ç¾¤æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š

```bash
npm run start:cluster
```

## API ç«¯ç‚¹

### POST /api/generate

æ ¹æ®æ–‡æœ¬æç¤ºç”Ÿæˆå›¾åƒå¹¶å°†å…¶å­˜å‚¨åœ¨ MinIO ä¸­ã€‚

**è¯·æ±‚ä½“ï¼š**

```json
{
  "prompt": "è¡—æ™¯ï¼Œ1ä¸ªå¥³å­©ï¼Œæ·±ç´«è‰²çŸ­å‘ï¼Œç´«è‰²çœ¼ç›ï¼Œä¸­ç­‰èƒ¸éƒ¨ï¼Œä¹³æ²Ÿï¼Œä¼‘é—²æœè£…ï¼Œå¾®ç¬‘ï¼ŒV",
  "negative_prompt": "nsfw, è£¸ä½“",
  "width": 1024,
  "height": 1024,
  "steps": 28,
  "batch_size": 1
}
```

**å“åº”ï¼š**

æˆåŠŸï¼ˆç«‹å³å®Œæˆï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "taskId": "ä»»åŠ¡ID",
    "urls": [
      "http://minio.example.com/images/replicate_12345678-1234-1234-1234-1234567890ab.png"
    ],
    "status": "succeeded"
  }
}
```

æˆåŠŸï¼ˆåå°å¤„ç†ï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "taskId": "ä»»åŠ¡ID",
    "message": "Image generation started",
    "status": "started"
  }
}
```

é”™è¯¯ï¼š
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯",
  "taskId": "ä»»åŠ¡IDï¼ˆå¦‚æœå·²åˆ›å»ºï¼‰"
}
```

### POST /api/generate/retry

é‡è¯•å¤±è´¥çš„å›¾åƒç”Ÿæˆä»»åŠ¡ã€‚

**è¯·æ±‚ä½“ï¼š**

```json
{
  "taskId": "éœ€è¦é‡è¯•çš„ä»»åŠ¡ID",
  "prompt": "è¡—æ™¯ï¼Œ1ä¸ªå¥³å­©ï¼Œæ·±ç´«è‰²çŸ­å‘ï¼Œç´«è‰²çœ¼ç›ï¼Œä¸­ç­‰èƒ¸éƒ¨ï¼Œä¹³æ²Ÿï¼Œä¼‘é—²æœè£…ï¼Œå¾®ç¬‘ï¼ŒV",
  "negative_prompt": "nsfw, è£¸ä½“",
  "width": 1024,
  "height": 1024,
  "steps": 28,
  "batch_size": 1
}
```

**å“åº”ï¼š**

```json
{
  "success": true,
  "data": {
    "taskId": "ä»»åŠ¡ID",
    "message": "Retry initiated successfully"
  }
}
```

### GET /api/generate/task/:taskId

æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€‚

**å“åº”ï¼š**

```json
{
  "success": true,
  "data": {
    "taskId": "ä»»åŠ¡ID",
    "status": "å½“å‰çŠ¶æ€",
    "prompt": "æç¤ºå†…å®¹",
    "urls": ["ç”Ÿæˆå›¾åƒURLï¼ˆå¦‚æœå·²å®Œæˆï¼‰"],
    "createdAt": "åˆ›å»ºæ—¶é—´",
    "completedAt": "å®Œæˆæ—¶é—´ï¼ˆå¦‚æœå·²å®Œæˆï¼‰"
  }
}
```

### GET /events

è¿æ¥åˆ° SSE äº‹ä»¶æµä»¥æ¥æ”¶å®æ—¶ä»»åŠ¡æ›´æ–°ã€‚

**æŸ¥è¯¢å‚æ•°ï¼š** 
- `taskId` (å¯é€‰) - æŒ‡å®šè¦ç›‘å¬çš„ä»»åŠ¡ ID

**äº‹ä»¶ç±»å‹ï¼š**
- `connected` - è¿æ¥å»ºç«‹æ—¶å‘é€
- `task_update` - ä»»åŠ¡çŠ¶æ€æ›´æ–°æ—¶å‘é€
- `heartbeat` - å®šæœŸå‘é€çš„å¿ƒè·³ä¿¡å·

## é…ç½®

é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼š

| å˜é‡ | æè¿° | é»˜è®¤å€¼ |
|----------|-------------|---------|
| PORT | æœåŠ¡å™¨ç«¯å£ | 3000 |
| REPLICATE_API_TOKEN | Replicate API ä»¤ç‰Œ | - |
| MINIO_ENDPOINT | MinIO æœåŠ¡å™¨ç«¯ç‚¹ | localhost:9000 |
| MINIO_ACCESS_KEY | MinIO è®¿é—®å¯†é’¥ | minioadmin |
| MINIO_SECRET_KEY | MinIO å¯†é’¥ | minioadmin |
| MINIO_BUCKET_NAME | MinIO å­˜å‚¨æ¡¶åç§° | images |
| MINIO_USE_SSL | æ˜¯å¦ä¸º MinIO ä½¿ç”¨ SSL | false |
| RABBITMQ_URL | RabbitMQ æœåŠ¡å™¨ URL | amqp://guest:guest@localhost:5672 |
| MAX_RETRIES | æœ€å¤§é‡è¯•æ¬¡æ•° | 3 |
| RETRY_INITIAL_INTERVAL | åˆå§‹é‡è¯•é—´éš”(æ¯«ç§’) | 10000 |

## å®æ—¶çŠ¶æ€æ›´æ–° (SSE)

æœåŠ¡ç°åœ¨æ”¯æŒé€šè¿‡ Server-Sent Events (SSE) å‘å®¢æˆ·ç«¯å®æ—¶æ¨é€ä»»åŠ¡çŠ¶æ€æ›´æ–°ã€‚è¿™ä½¿å®¢æˆ·ç«¯å¯ä»¥å®æ—¶æ˜¾ç¤ºä»»åŠ¡è¿›åº¦ï¼Œè€Œä¸éœ€è¦è½®è¯¢ã€‚

**è¿æ¥åˆ° SSE ç«¯ç‚¹**ï¼š
```javascript
const eventSource = new EventSource('/events?taskId=your_task_id');

eventSource.addEventListener('task_update', (event) => {
  const data = JSON.parse(event.data);
  console.log(`Task ${data.taskId} status: ${data.status}`);
  // æ›´æ–° UI
});
```

å¯ç”¨çš„ä»»åŠ¡çŠ¶æ€åŒ…æ‹¬ï¼š`started`, `queued`, `processing`, `downloading`, `succeeded`, `failed`, `retrying` ç­‰ã€‚

## å¯é çš„é‡è¯•æœºåˆ¶

æœåŠ¡ç°åœ¨ä½¿ç”¨ RabbitMQ å®ç°äº†å¯é çš„ä»»åŠ¡é‡è¯•æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **æŒ‡æ•°é€€é¿é‡è¯•**: å¤±è´¥çš„ä»»åŠ¡ä¼šè‡ªåŠ¨ä»¥æŒ‡æ•°é€’å¢çš„æ—¶é—´é—´éš”é‡è¯•
2. **å¯é…ç½®çš„é‡è¯•å‚æ•°**: å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ã€åˆå§‹é‡è¯•é—´éš”å’Œæœ€å¤§é‡è¯•é—´éš”
3. **æ‰‹åŠ¨é‡è¯• API**: æä¾›äº†æ‰‹åŠ¨è§¦å‘ä»»åŠ¡é‡è¯•çš„ API
4. **æ­»ä¿¡é˜Ÿåˆ—**: è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°çš„ä»»åŠ¡å°†ç§»è‡³æ­»ä¿¡é˜Ÿåˆ—ä»¥ä¾¿åç»­åˆ†æ

## RabbitMQ é…ç½®

RabbitMQ ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—å’Œä»»åŠ¡é‡è¯•æœºåˆ¶ã€‚

### åŸºæœ¬é…ç½®

1. ç¡®ä¿ RabbitMQ æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
2. æœåŠ¡å°†ä½¿ç”¨ä»¥ä¸‹è¿æ¥URLï¼š`amqp://rabbitmq:hBw8C74RY5GJHRCF@localhost:5672`ï¼Œå…¶ä¸­åŒ…å«ï¼š
   - ç”¨æˆ·åï¼š`rabbitmq`
   - å¯†ç ï¼š`hBw8C74RY5GJHRCF`
   - ä¸»æœºï¼š`localhost`
   - ç«¯å£ï¼š`5672`
3. æœåŠ¡å°†è‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„é˜Ÿåˆ—ï¼š
   - `img_generation_queue`: ç”¨äºå¤„ç†å›¾åƒç”Ÿæˆä»»åŠ¡
   - `img_retry_queue`: ç”¨äºé‡è¯•å¤±è´¥çš„ä»»åŠ¡
   - `img_dead_letter_queue`: ç”¨äºå­˜å‚¨æœ€ç»ˆå¤±è´¥çš„ä»»åŠ¡

### RabbitMQ Web ç®¡ç†ç•Œé¢é…ç½®

RabbitMQ æä¾›äº†ä¸€ä¸ª Web ç®¡ç†ç•Œé¢ï¼Œå¯ä»¥ç”¨äºç›‘æ§å’Œç®¡ç†é˜Ÿåˆ—ï¼š

1. **å¯ç”¨ RabbitMQ ç®¡ç†æ’ä»¶**:
   ```bash
   rabbitmq-plugins enable rabbitmq_management
   ```

2. **è®¿é—®ç®¡ç†ç•Œé¢**:
   - æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® `http://<rabbitmq-server-ip>:15672/`
   - é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ä¸º `guest` / `guest`ï¼ˆä»…åœ¨localhostè®¿é—®æ—¶æœ‰æ•ˆï¼‰
   
3. **åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·**ï¼ˆæ¨èï¼‰:
   ```bash
   rabbitmqctl add_user admin your_password
   rabbitmqctl set_user_tags admin administrator
   rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
   ```

4. **ç›‘æ§é˜Ÿåˆ—**:
   - åœ¨ Web ç•Œé¢çš„ "Queues" æ ‡ç­¾é¡µä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å·²åˆ›å»ºçš„é˜Ÿåˆ—
   
## å·¥ä½œæµç¨‹

1. å‰ç«¯å‘é€åŒ…å«ç”Ÿæˆå›¾åƒè¯·æ±‚çš„ POST è¯·æ±‚
2. æœåŠ¡åˆ›å»ºä»»åŠ¡å¹¶å°†å…¶æ·»åŠ åˆ° RabbitMQ é˜Ÿåˆ—
3. å·¥ä½œè¿›ç¨‹æ¶ˆè´¹ä»»åŠ¡å¹¶è°ƒç”¨ Replicate API ç”Ÿæˆå›¾åƒ
4. åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡é€šè¿‡ SSE å‘å®¢æˆ·ç«¯å‘é€å®æ—¶çŠ¶æ€æ›´æ–°
5. æˆåŠŸç”Ÿæˆçš„å›¾åƒä¿å­˜åˆ° MinIO å­˜å‚¨æ¡¶
6. æœåŠ¡è¿”å› MinIO ä¸­å›¾åƒæ–‡ä»¶çš„ URL
7. å¦‚æœç”Ÿæˆå¤±è´¥ï¼ŒæœåŠ¡ä¼šæ ¹æ®é…ç½®çš„é‡è¯•ç­–ç•¥è‡ªåŠ¨é‡è¯•

## æµ‹è¯•

è¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œç”¨äºéªŒè¯åç«¯æœåŠ¡çš„å®Œæ•´æµç¨‹ã€‚æµ‹è¯•è„šæœ¬å°†å‘é€å›¾åƒç”Ÿæˆè¯·æ±‚ï¼Œå¹¶ä¸‹è½½ç”Ÿæˆçš„å›¾ç‰‡åˆ°æœ¬åœ°ã€‚

### è¿è¡Œæµ‹è¯•

ç¡®ä¿ `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®ï¼Œç„¶åè¿è¡Œï¼š

```bash
npm test
```

æµ‹è¯•è„šæœ¬å°†ï¼š
1. å‘åç«¯å‘é€å›¾åƒç”Ÿæˆè¯·æ±‚
2. ç­‰å¾…å›¾åƒç”Ÿæˆå®Œæˆ
3. ä¸‹è½½ç”Ÿæˆçš„å›¾åƒåˆ° `tests/output` ç›®å½•
4. æä¾›è¯¦ç»†çš„ä¸­æ–‡æ—¥å¿—ï¼Œè®°å½•æ•´ä¸ªè¿‡ç¨‹

### è‡ªå®šä¹‰æµ‹è¯•å‚æ•°

ä½ å¯ä»¥åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½® `TEST_SERVER_URL` æ¥æµ‹è¯•ä¸åŒç¯å¢ƒä¸­çš„åç«¯æœåŠ¡ï¼š

```
TEST_SERVER_URL=http://yourserver.com:3000
```

ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ `tests/test-generate.js` æ–‡ä»¶ä¸­çš„ `config.testParams` å¯¹è±¡æ¥è‡ªå®šä¹‰æµ‹è¯•å‚æ•°ã€‚

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

æµ‹è¯•è„šæœ¬è¿è¡Œæ—¶ä¼šæ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹çš„è¯¦ç»†ä¸­æ–‡æ—¥å¿—ï¼š

```
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: Replicate Text2Img åç«¯æµ‹è¯•è„šæœ¬å¯åŠ¨
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: Node.js ç‰ˆæœ¬: v18.12.1
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: ========== å¼€å§‹æµ‹è¯•ä¼šè¯ ID: a1b2c3d4 ==========
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: åç«¯æœåŠ¡åœ°å€: http://localhost:3000
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: å‡†å¤‡å‘é€ä»¥ä¸‹å‚æ•°:
{
  "prompt": "é«˜æ¸…åŠ¨æ¼«é£æ™¯ï¼Œæ¨±èŠ±æ ‘ä¸‹çš„æ—¥æœ¬ä¼ ç»Ÿç¥ç¤¾ï¼Œé»„æ˜æ—¶åˆ†ï¼Œäº‘å½©ï¼Œç»†èŠ‚ä¸°å¯Œ",
  "negative_prompt": "nsfw, ä½è´¨é‡, æ¨¡ç³Š, ç•¸å½¢, ä¸å®Œæ•´",
  "width": 1024,
  "height": 1024,
  "steps": 28,
  "batch_size": 1
}
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: æ­£åœ¨å‘ http://localhost:3000/generate å‘é€ POST è¯·æ±‚...
[2023-11-30 15:31:45] âœ… æˆåŠŸ: è¯·æ±‚æˆåŠŸå®Œæˆï¼è€—æ—¶: 60.00 ç§’
[2023-11-30 15:31:45] âœ… æˆåŠŸ: æœåŠ¡å™¨è¿”å› 1 ä¸ªå›¾ç‰‡URL:
[
  "http://localhost:9000/images/replicate_a1b2c3d4-1234-1234-1234-1234567890ab.png"
]
[2023-11-30 15:31:45] ğŸ“¢ ä¿¡æ¯: å¼€å§‹ä¸‹è½½ç”Ÿæˆçš„å›¾ç‰‡...
[2023-11-30 15:31:45] ğŸ“¢ ä¿¡æ¯: å¼€å§‹ä¸‹è½½å›¾ç‰‡: http://localhost:9000/images/replicate_a1b2c3d4-1234-1234-1234-1234567890ab.png
[2023-11-30 15:31:46] âœ… æˆåŠŸ: å›¾ç‰‡å·²ä¿å­˜åˆ°: f:\my-app\replicate-text2img\tests\output\test_a1b2c3d4_image_1.png
[2023-11-30 15:31:46] âœ… æˆåŠŸ: ========== æµ‹è¯•å®Œæˆ ==========
[2023-11-30 15:31:46] ğŸ“¢ ä¿¡æ¯: æ€»è€—æ—¶: 61.00 ç§’
[2023-11-30 15:31:46] âœ… æˆåŠŸ: æˆåŠŸç”Ÿæˆå¹¶ä¸‹è½½äº† 1 ä¸ªå›¾ç‰‡:
[2023-11-30 15:31:46] ğŸ“¢ ä¿¡æ¯: - f:\my-app\replicate-text2img\tests\output\test_a1b2c3d4_image_1.png
[2023-11-30 15:31:46] ğŸ“¢ ä¿¡æ¯: ========== æµ‹è¯•ä¼šè¯ ID: a1b2c3d4 ç»“æŸ ==========
```

## è¿è¡Œæµ‹è¯•è„šæœ¬

åœ¨å®å¡”é¢æ¿éƒ¨ç½²åè¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œæ‚¨æœ‰ä¸¤ç§æ–¹å¼ï¼š

### æ–¹å¼1ï¼šåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥è¿è¡Œ

1. é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨
2. å¯¼èˆªåˆ°é¡¹ç›®ç›®å½•
3. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
   ```bash
   npm test
   ```

### æ–¹å¼2ï¼šä»æœ¬åœ°è¿è¡Œæµ‹è¯•è„šæœ¬

1. å°†é¡¹ç›®å…‹éš†åˆ°æœ¬åœ°è®¡ç®—æœº
2. å®‰è£…ä¾èµ–ï¼š
   ```bash
   npm install
   ```
3. ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œå°† `TEST_SERVER_URL` è®¾ç½®ä¸ºæ‚¨çš„å®å¡”æœåŠ¡å™¨åœ°å€ï¼š
   ```
   TEST_SERVER_URL=http://your-server-ip:3000
   ```
   æˆ–
   ```
   TEST_SERVER_URL=http://your-domain.com
   ```
4. è¿è¡Œæµ‹è¯•ï¼š
   ```bash
   npm test
   ```

## æ•…éšœæ’é™¤

### 1. "Cannot find module 'node-fetch'"

å¦‚æœæ‚¨çœ‹åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š

```
Error: Cannot find module 'node-fetch'
```

è¿™è¡¨æ˜ node-fetch æ¨¡å—å°šæœªå®‰è£…ã€‚è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®ƒï¼š

```bash
npm install node-fetch@2
```

### 2. "Headers is not defined" æˆ– "_fetch is not function"

è¿™äº›é”™è¯¯æ˜¯ Node.js ç‰ˆæœ¬ä¸ Replicate åº“çš„å…¼å®¹æ€§é—®é¢˜ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š

1. ç¡®ä¿å·²å®‰è£… node-fetch æ¨¡å— (ç‰ˆæœ¬ 2):
   ```bash
   npm install node-fetch@2
   ```

2. å¯ä»¥å°è¯•è¿è¡Œè‡ªåŠ¨ä¿®å¤è„šæœ¬:
   ```bash
   bash install-script.sh
   ```

3. å¦‚æœä»¥ä¸Šæ–¹æ³•ä¸èµ·ä½œç”¨ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ Replicate åº“çš„æºä»£ç :
   ```bash
   # æŸ¥æ‰¾ replicate åº“è·¯å¾„
   find node_modules -name "index.js" | grep replicate
   
   # ç¼–è¾‘æ‰¾åˆ°çš„æ–‡ä»¶ï¼Œåœ¨å¼€å¤´æ·»åŠ ä»¥ä¸‹ä»£ç 
   # const nodeFetch = require('node-fetch');
   # const fetch = nodeFetch.default || nodeFetch;
   # const Headers = nodeFetch.Headers;
   # global.fetch = fetch;
   # global.Headers = Headers;
   ```

### 3. ä½ç‰ˆæœ¬ Node.js çš„å…¼å®¹æ€§é—®é¢˜

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯è¾ƒæ—§ç‰ˆæœ¬çš„ Node.js (ä½äº v16)ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§å…¼å®¹æ€§é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆæœ‰ä»¥ä¸‹é€‰æ‹©ï¼š

1. å‡çº§ Node.js åˆ° v16 æˆ–æ›´é«˜ç‰ˆæœ¬ (æ¨è):
   ```bash
   # ä½¿ç”¨ nvm (Node Version Manager) å®‰è£…æœ€æ–°ç‰ˆæœ¬
   nvm install 16
   nvm use 16
   ```

2. å®‰è£…å…¼å®¹æ€§ä¾èµ–:
   ```bash
   npm install node-fetch@2 form-data@4 abort-controller@3
   ```

3. é™çº§ Replicate åº“ç‰ˆæœ¬:
   ```bash
   npm install replicate@0.12.0
   ```

### æ•…éšœæ’é™¤

å¦‚æœæµ‹è¯•è„šæœ¬æŠ¥é”™ï¼š

1. **"Headers is not defined"**ï¼š
   - è¿™æ˜¯ç”±äº Node.js ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼Œç¡®ä¿å®‰è£…äº† `node-fetch` åŒ…ï¼š
   ```bash
   npm install node-fetch@2
   ```

2. **è¿æ¥è¢«æ‹’ç»**ï¼š
   - æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
   - éªŒè¯é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤ç«¯å£æ˜¯å¦æ­£ç¡®

3. **API Token é—®é¢˜**ï¼š
   - ç¡®ä¿æ‚¨çš„ `.env` æ–‡ä»¶ä¸­æœ‰æ­£ç¡®çš„ Replicate API Token
   - éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ

4. **MinIO é—®é¢˜**ï¼š
   - ç¡®ä¿ MinIO æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
   - éªŒè¯ MinIO å‡­æ®æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†æ­£ç¡®çš„å­˜å‚¨æ¡¶
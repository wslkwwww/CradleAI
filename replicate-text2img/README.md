## Replicate æ–‡æœ¬åˆ°å›¾åƒåç«¯æœåŠ¡

ä¸€ä¸ªä½¿ç”¨ Replicate API ç”Ÿæˆå›¾åƒå¹¶å°†å›¾åƒå­˜å‚¨åœ¨ MinIO å¯¹è±¡å­˜å‚¨ä¸­çš„ Node.js åç«¯æœåŠ¡ã€‚

## ç‰¹ç‚¹

- ä½¿ç”¨ Replicate çš„æ–‡æœ¬åˆ°å›¾åƒæ¨¡å‹ (Animagine-XL-4.0) ç”Ÿæˆå›¾åƒ
- å°†ç”Ÿæˆçš„å›¾åƒå­˜å‚¨åœ¨ MinIO å¯¹è±¡å­˜å‚¨ä¸­
- ç”¨äºå›¾åƒç”Ÿæˆçš„ RESTful API ç«¯ç‚¹
- å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
- åŸºäºç¯å¢ƒçš„é…ç½®

## è®¾ç½®

### å‰ææ¡ä»¶

- Node.js v14+
- MinIO æœåŠ¡å™¨
- Replicate API ä»¤ç‰Œ

### å®‰è£…

1. å…‹éš†ä»“åº“
2. å®‰è£…ä¾èµ–é¡¹ï¼š

```bash
npm install
```

3. åŸºäº `.env.example` æ–‡ä»¶åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cp .env.example .env
```

4. ä½¿ç”¨æ‚¨çš„å‡­æ®å’Œé…ç½®ç¼–è¾‘ `.env` æ–‡ä»¶ã€‚

### è¿è¡ŒæœåŠ¡

å¯åŠ¨æœåŠ¡å™¨ï¼š

```bash
npm start
```

ç”¨äºå¸¦æœ‰è‡ªåŠ¨é‡è½½çš„å¼€å‘ï¼š

```bash
npm run dev
```

## API ç«¯ç‚¹

### POST /generate

æ ¹æ®æ–‡æœ¬æç¤ºç”Ÿæˆå›¾åƒå¹¶å°†å…¶å­˜å‚¨åœ¨ MinIO ä¸­ã€‚

**è¯·æ±‚ä½“ï¼š**

```json
{
  "prompt": "è¡—æ™¯ï¼Œ1ä¸ªå¥³å­©ï¼Œæ·±ç´«è‰²çŸ­å‘ï¼Œç´«è‰²çœ¼ç›ï¼Œä¸­ç­‰èƒ¸éƒ¨ï¼Œä¹³æ²Ÿï¼Œä¼‘é—²æœè£…ï¼Œå¾®ç¬‘ï¼ŒV",
  "negative_prompt": "nsfw, è£¸ä½“",
  "width": 1024,
  "height": 1024,
  "steps": 28,
  "batch_size": 1
}
```

**å“åº”ï¼š**

```json
{
  "urls": [
    "http://minio.example.com/images/replicate_12345678-1234-1234-1234-1234567890ab.png"
  ]
}
```

## é…ç½®

é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼š

| å˜é‡ | æè¿° | é»˜è®¤å€¼ |
|----------|-------------|---------|
| PORT | æœåŠ¡å™¨ç«¯å£ | 3000 |
| REPLICATE_API_TOKEN | Replicate API ä»¤ç‰Œ | - |
| MINIO_ENDPOINT | MinIO æœåŠ¡å™¨ç«¯ç‚¹ | localhost:9000 |
| MINIO_ACCESS_KEY | MinIO è®¿é—®å¯†é’¥ | minioadmin |
| MINIO_SECRET_KEY | MinIO å¯†é’¥ | minioadmin |
| MINIO_BUCKET_NAME | MinIO å­˜å‚¨æ¡¶åç§° | images |
| MINIO_USE_SSL | æ˜¯å¦ä¸º MinIO ä½¿ç”¨ SSL | false |

## é”™è¯¯å¤„ç†

è¯¥æœåŠ¡åŒ…æ‹¬é’ˆå¯¹å„ç§åœºæ™¯çš„å…¨é¢é”™è¯¯å¤„ç†ï¼š

- æ— æ•ˆçš„è¯·æ±‚å‚æ•°
- Replicate API é”™è¯¯
- MinIO å­˜å‚¨é”™è¯¯
- ç½‘ç»œé”™è¯¯

## éƒ¨ç½²

### ç¯å¢ƒè®¾ç½®

1. ç¡®ä¿æ‚¨çš„æœåŠ¡å™¨ä¸Šå·²å®‰è£… Node.js
2. é…ç½® MinIO æœåŠ¡å™¨å¹¶åˆ›å»ºæ‰€éœ€çš„å­˜å‚¨æ¡¶
3. ä½¿ç”¨æ­£ç¡®çš„å‡­æ®è®¾ç½®ç¯å¢ƒå˜é‡

### ä½¿ç”¨ PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰

å¯¹äºç”Ÿäº§éƒ¨ç½²ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ PM2ï¼š

```bash
npm install -g pm2
pm2 start server.js --name replicate-text2img
```

### ä½¿ç”¨ Docker (å¯é€‰)

æä¾›äº†ä¸€ä¸ª Dockerfile ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²ï¼š

```bash
docker build -t replicate-text2img .
docker run -p 3000:3000 --env-file .env replicate-text2img
```

## å®å¡”é¢æ¿éƒ¨ç½²è¯´æ˜

å¦‚æœæ‚¨è¦åœ¨å®å¡”é¢æ¿ä¸Šéƒ¨ç½²æ­¤åº”ç”¨ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. åœ¨å®å¡”é¢æ¿ä¸­åˆ›å»ºä¸€ä¸ªç«™ç‚¹ï¼Œå¹¶è®¾ç½®è¿è¡Œç›®å½•ä¸ºé¡¹ç›®æ ¹ç›®å½•

2. åœ¨"ç½‘ç«™"ä¸­æ‰¾åˆ°æ‚¨çš„ç«™ç‚¹ï¼Œç‚¹å‡»"è®¾ç½®"ï¼Œç„¶åç‚¹å‡»"é…ç½®æ–‡ä»¶"

3. æ·»åŠ åå‘ä»£ç†é…ç½®ï¼š
   ```
   location / {
       proxy_pass http://127.0.0.1:3000;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
   }
   ```

4. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶åˆ°ç«™ç‚¹ç›®å½•ä¸­

5. é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¿›å…¥é¡¹ç›®ç›®å½•

6. å®‰è£…ä¾èµ–ï¼š
   ```bash
   npm install
   ```

7. åˆ›å»ºå¹¶ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œè®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡

8. ä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨ï¼š
   ```bash
   npm install -g pm2
   pm2 start server.js --name replicate-text2img
   ```

9. ç¡®ä¿æ‚¨çš„æœåŠ¡å™¨é˜²ç«å¢™å…è®¸ç›¸å…³ç«¯å£çš„è®¿é—®

## æµ‹è¯•

è¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œç”¨äºéªŒè¯åç«¯æœåŠ¡çš„å®Œæ•´æµç¨‹ã€‚æµ‹è¯•è„šæœ¬å°†å‘é€å›¾åƒç”Ÿæˆè¯·æ±‚ï¼Œå¹¶ä¸‹è½½ç”Ÿæˆçš„å›¾ç‰‡åˆ°æœ¬åœ°ã€‚

### è¿è¡Œæµ‹è¯•

ç¡®ä¿ `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®ï¼Œç„¶åè¿è¡Œï¼š

```bash
npm test
```

æµ‹è¯•è„šæœ¬å°†ï¼š
1. å‘åç«¯å‘é€å›¾åƒç”Ÿæˆè¯·æ±‚
2. ç­‰å¾…å›¾åƒç”Ÿæˆå®Œæˆ
3. ä¸‹è½½ç”Ÿæˆçš„å›¾åƒåˆ° `tests/output` ç›®å½•
4. æä¾›è¯¦ç»†çš„ä¸­æ–‡æ—¥å¿—ï¼Œè®°å½•æ•´ä¸ªè¿‡ç¨‹

### è‡ªå®šä¹‰æµ‹è¯•å‚æ•°

ä½ å¯ä»¥åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½® `TEST_SERVER_URL` æ¥æµ‹è¯•ä¸åŒç¯å¢ƒä¸­çš„åç«¯æœåŠ¡ï¼š

```
TEST_SERVER_URL=http://yourserver.com:3000
```

ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ `tests/test-generate.js` æ–‡ä»¶ä¸­çš„ `config.testParams` å¯¹è±¡æ¥è‡ªå®šä¹‰æµ‹è¯•å‚æ•°ã€‚

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

æµ‹è¯•è„šæœ¬è¿è¡Œæ—¶ä¼šæ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹çš„è¯¦ç»†ä¸­æ–‡æ—¥å¿—ï¼š

```
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: Replicate Text2Img åç«¯æµ‹è¯•è„šæœ¬å¯åŠ¨
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: Node.js ç‰ˆæœ¬: v18.12.1
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: ========== å¼€å§‹æµ‹è¯•ä¼šè¯ ID: a1b2c3d4 ==========
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: åç«¯æœåŠ¡åœ°å€: http://localhost:3000
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: å‡†å¤‡å‘é€ä»¥ä¸‹å‚æ•°:
{
  "prompt": "é«˜æ¸…åŠ¨æ¼«é£æ™¯ï¼Œæ¨±èŠ±æ ‘ä¸‹çš„æ—¥æœ¬ä¼ ç»Ÿç¥ç¤¾ï¼Œé»„æ˜æ—¶åˆ†ï¼Œäº‘å½©ï¼Œç»†èŠ‚ä¸°å¯Œ",
  "negative_prompt": "nsfw, ä½è´¨é‡, æ¨¡ç³Š, ç•¸å½¢, ä¸å®Œæ•´",
  "width": 1024,
  "height": 1024,
  "steps": 28,
  "batch_size": 1
}
[2023-11-30 15:30:45] ğŸ“¢ ä¿¡æ¯: æ­£åœ¨å‘ http://localhost:3000/generate å‘é€ POST è¯·æ±‚...
[2023-11-30 15:31:45] âœ… æˆåŠŸ: è¯·æ±‚æˆåŠŸå®Œæˆï¼è€—æ—¶: 60.00 ç§’
[2023-11-30 15:31:45] âœ… æˆåŠŸ: æœåŠ¡å™¨è¿”å› 1 ä¸ªå›¾ç‰‡URL:
[
  "http://localhost:9000/images/replicate_a1b2c3d4-1234-1234-1234-1234567890ab.png"
]
[2023-11-30 15:31:45] ğŸ“¢ ä¿¡æ¯: å¼€å§‹ä¸‹è½½ç”Ÿæˆçš„å›¾ç‰‡...
[2023-11-30 15:31:45] ğŸ“¢ ä¿¡æ¯: å¼€å§‹ä¸‹è½½å›¾ç‰‡: http://localhost:9000/images/replicate_a1b2c3d4-1234-1234-1234-1234567890ab.png
[2023-11-30 15:31:46] âœ… æˆåŠŸ: å›¾ç‰‡å·²ä¿å­˜åˆ°: f:\my-app\replicate-text2img\tests\output\test_a1b2c3d4_image_1.png
[2023-11-30 15:31:46] âœ… æˆåŠŸ: ========== æµ‹è¯•å®Œæˆ ==========
[2023-11-30 15:31:46] ğŸ“¢ ä¿¡æ¯: æ€»è€—æ—¶: 61.00 ç§’
[2023-11-30 15:31:46] âœ… æˆåŠŸ: æˆåŠŸç”Ÿæˆå¹¶ä¸‹è½½äº† 1 ä¸ªå›¾ç‰‡:
[2023-11-30 15:31:46] ğŸ“¢ ä¿¡æ¯: - f:\my-app\replicate-text2img\tests\output\test_a1b2c3d4_image_1.png
[2023-11-30 15:31:46] ğŸ“¢ ä¿¡æ¯: ========== æµ‹è¯•ä¼šè¯ ID: a1b2c3d4 ç»“æŸ ==========
```

## è¿è¡Œæµ‹è¯•è„šæœ¬

åœ¨å®å¡”é¢æ¿éƒ¨ç½²åè¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œæ‚¨æœ‰ä¸¤ç§æ–¹å¼ï¼š

### æ–¹å¼1ï¼šåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥è¿è¡Œ

1. é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨
2. å¯¼èˆªåˆ°é¡¹ç›®ç›®å½•
3. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
   ```bash
   npm test
   ```

### æ–¹å¼2ï¼šä»æœ¬åœ°è¿è¡Œæµ‹è¯•è„šæœ¬

1. å°†é¡¹ç›®å…‹éš†åˆ°æœ¬åœ°è®¡ç®—æœº
2. å®‰è£…ä¾èµ–ï¼š
   ```bash
   npm install
   ```
3. ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œå°† `TEST_SERVER_URL` è®¾ç½®ä¸ºæ‚¨çš„å®å¡”æœåŠ¡å™¨åœ°å€ï¼š
   ```
   TEST_SERVER_URL=http://your-server-ip:3000
   ```
   æˆ–
   ```
   TEST_SERVER_URL=http://your-domain.com
   ```
4. è¿è¡Œæµ‹è¯•ï¼š
   ```bash
   npm test
   ```

## æ•…éšœæ’é™¤

### 1. "Cannot find module 'node-fetch'"

å¦‚æœæ‚¨çœ‹åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š

```
Error: Cannot find module 'node-fetch'
```

è¿™è¡¨æ˜ node-fetch æ¨¡å—å°šæœªå®‰è£…ã€‚è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®ƒï¼š

```bash
npm install node-fetch@2
```

### 2. "Headers is not defined" æˆ– "_fetch is not function"

è¿™äº›é”™è¯¯æ˜¯ Node.js ç‰ˆæœ¬ä¸ Replicate åº“çš„å…¼å®¹æ€§é—®é¢˜ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š

1. ç¡®ä¿å·²å®‰è£… node-fetch æ¨¡å— (ç‰ˆæœ¬ 2):
   ```bash
   npm install node-fetch@2
   ```

2. å¯ä»¥å°è¯•è¿è¡Œè‡ªåŠ¨ä¿®å¤è„šæœ¬:
   ```bash
   bash install-script.sh
   ```

3. å¦‚æœä»¥ä¸Šæ–¹æ³•ä¸èµ·ä½œç”¨ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ Replicate åº“çš„æºä»£ç :
   ```bash
   # æŸ¥æ‰¾ replicate åº“è·¯å¾„
   find node_modules -name "index.js" | grep replicate
   
   # ç¼–è¾‘æ‰¾åˆ°çš„æ–‡ä»¶ï¼Œåœ¨å¼€å¤´æ·»åŠ ä»¥ä¸‹ä»£ç 
   # const nodeFetch = require('node-fetch');
   # const fetch = nodeFetch.default || nodeFetch;
   # const Headers = nodeFetch.Headers;
   # global.fetch = fetch;
   # global.Headers = Headers;
   ```

### 3. ä½ç‰ˆæœ¬ Node.js çš„å…¼å®¹æ€§é—®é¢˜

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯è¾ƒæ—§ç‰ˆæœ¬çš„ Node.js (ä½äº v16)ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§å…¼å®¹æ€§é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆæœ‰ä»¥ä¸‹é€‰æ‹©ï¼š

1. å‡çº§ Node.js åˆ° v16 æˆ–æ›´é«˜ç‰ˆæœ¬ (æ¨è):
   ```bash
   # ä½¿ç”¨ nvm (Node Version Manager) å®‰è£…æœ€æ–°ç‰ˆæœ¬
   nvm install 16
   nvm use 16
   ```

2. å®‰è£…å…¼å®¹æ€§ä¾èµ–:
   ```bash
   npm install node-fetch@2 form-data@4 abort-controller@3
   ```

3. é™çº§ Replicate åº“ç‰ˆæœ¬:
   ```bash
   npm install replicate@0.12.0
   ```

### æ•…éšœæ’é™¤

å¦‚æœæµ‹è¯•è„šæœ¬æŠ¥é”™ï¼š

1. **"Headers is not defined"**ï¼š
   - è¿™æ˜¯ç”±äº Node.js ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼Œç¡®ä¿å®‰è£…äº† `node-fetch` åŒ…ï¼š
   ```bash
   npm install node-fetch@2
   ```

2. **è¿æ¥è¢«æ‹’ç»**ï¼š
   - æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
   - éªŒè¯é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤ç«¯å£æ˜¯å¦æ­£ç¡®

3. **API Token é—®é¢˜**ï¼š
   - ç¡®ä¿æ‚¨çš„ `.env` æ–‡ä»¶ä¸­æœ‰æ­£ç¡®çš„ Replicate API Token
   - éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ

4. **MinIO é—®é¢˜**ï¼š
   - ç¡®ä¿ MinIO æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
   - éªŒè¯ MinIO å‡­æ®æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†æ­£ç¡®çš„å­˜å‚¨æ¡¶